# .github/workflows/ci.yml
name: CI â€“ Build & Tests

# DÃ©clencheurs : sur push ET pull_request vers main et dev et etc...
on:
  push:
    branches:
      - main
      - dev
      - "feat/**"
      - "fix/**"
      - "refactor/**"
      - "docs/**"
      - "test/**"
      - "chore/**"
      - "perf/**"
      - "style/**"
      - "build/**"
      - "ci/**"
      - "revert/**"
      - "release/**"
      - "workflow/**"
      - "feature/**"
      - "bugfix/**"
      - "refactor/**"
      - "docs/**"
      - "test/**"
      - "chore/**"
      - "perf/**"
      - "style/**"
      - "build/**"
      - "ci/**"
      - "revert/**"
      - "release/**"
      - "workflow/**"
  pull_request:
    branches:
      - main
      - dev
      - "feat/**"
      - "fix/**"
      - "refactor/**"
      - "docs/**"
      - "test/**"
      - "chore/**"
      - "perf/**"
      - "style/**"
      - "build/**"
      - "ci/**"
      - "revert/**"
      - "release/**"
      - "workflow/**"
      - "feature/**"
      - "bugfix/**"
      - "refactor/**"
      - "docs/**"
      - "test/**"
      - "chore/**"
      - "perf/**"
      - "style/**"
      - "build/**"
      - "ci/**"
      - "revert/**"
      - "release/**"
      - "workflow/**"

# Evite les runs redondants (annule le run prÃ©cÃ©dent si un nouveau push arrive)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 : Compilation et Tests du module services
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-services:
    name: ğŸ”¨ Build & Tests Java (services)
    runs-on: ubuntu-latest

    steps:
      # 1. RÃ©cupÃ¨re le code source
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      # 2. Configure Java 21 (Temurin = OpenJDK gratuit de Adoptium)
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven" # Cache automatique de ~/.m2

      # 3. Compile + Lance les tests + GÃ©nÃ¨re le JAR
      - name: ğŸ§ª Compilation et tests (mvn verify)
        run: mvn clean verify --no-transfer-progress
        working-directory: .
        # --no-transfer-progress = logs propres sans barres de progression

      # 4. Publie le rapport de tests JUnit dans l'interface GitHub
      - name: ğŸ“Š Publier le rapport de tests
        uses: dorny/test-reporter@v1
        if: always() # Toujours exÃ©cuter, mÃªme si les tests Ã©chouent
        with:
          name: Rapport JUnit â€“ Services
          path: services/target/surefire-reports/TEST-*.xml
          reporter: java-junit

      # 5. Sauvegarde le JAR comme artifact tÃ©lÃ©chargeable
      - name: ğŸ“¦ Upload du JAR (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: services-jar
          path: services/target/demande-conge-extension-services.jar
          retention-days: 7 # Disponible 7 jours

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 : Build du module webapp (Vue.js + WAR)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-webapp:
    name: ğŸŒ Build Vue.js & WAR (webapp)
    runs-on: ubuntu-latest
    # Ce job dÃ©marre en PARALLÃˆLE avec build-services (pas de dÃ©pendance)

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      # Node.js pour le build Vue.js
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webapp/package-lock.json

      # Java nÃ©cessaire pour mvn package (gÃ©nÃ¨re le WAR)
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      # Installation des dÃ©pendances NPM (version exacte du lock file)
      - name: ğŸ“¦ Installation des dÃ©pendances NPM
        run: npm ci
        working-directory: webapp

      # Build Vue.js avec Webpack
      - name: ğŸ—ï¸ Build Vue.js (npm run build)
        run: npm run build
        working-directory: webapp

      # Package Maven pour gÃ©nÃ©rer le WAR final
      - name: ğŸ—ï¸ Package Maven (gÃ©nÃ©ration WAR)
        run: mvn package -pl webapp -am --no-transfer-progress -DskipTests
        # -pl webapp : seulement le module webapp
        # -am : include les modules dont il dÃ©pend (parent pom)
        # -DskipTests : on a dÃ©jÃ  testÃ© dans le job 1

      # Upload du WAR
      - name: ğŸ“¦ Upload du WAR (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: webapp-war
          path: webapp/target/demande-conge-extension-webapp.war
          retention-days: 7