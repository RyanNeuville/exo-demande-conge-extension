# .github/workflows/ci.yml
name: CI â€“ Build & Tests

on:
    push:
        branches: ["**"]
    pull_request:
        branches: [main, dev]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # JOB 1 : Compilation + Tests Java
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    build-services:
        name: ğŸ”¨ Build Java (services)
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: â˜• Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: ğŸ§ª Compilation & Tests
              run: mvn clean verify --no-transfer-progress

            - name: ğŸ“¦ Upload JAR
              uses: actions/upload-artifact@v4
              with:
                  name: services-jar
                  path: services/target/demande-conge-extension-services.jar
                  retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # JOB 2 : Build Frontend (Vue.js + WAR)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    build-webapp:
        name: ğŸŒ Build Vue.js & WAR (webapp)
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js 20
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: â˜• Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: ğŸ“¦ Installation NPM
              run: npm install --legacy-peer-deps
              working-directory: webapp

            - name: ğŸ—ï¸ Build Vue.js
              run: npm run build
              working-directory: webapp

            - name: ğŸ—ï¸ Package WAR
              run: mvn package -pl webapp -am --no-transfer-progress -DskipTests

            - name: ğŸ“¦ Upload WAR
              uses: actions/upload-artifact@v4
              with:
                  name: webapp-war
                  path: webapp/target/demande-conge-extension-webapp.war
                  retention-days: 7
